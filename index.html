<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Generador de cócteles imprimibles · v5.8 · 25/09/2025</title>
<meta name="version" content="v5.8"/>
<meta name="last-modified" content="2025-09-25"/>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Playfair+Display:wght@700&display=swap');
  :root{--theme:#0b3d20;--bg:#ffffff}
  body{margin:0;background:#fdfbf7;color:#1a1a1a;font-family:'Montserrat',sans-serif}
  .app{max-width:1000px;margin:auto;padding:18px}
  .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:10px}
  .controls label{font-size:13px}
  select,input[type=file],input[type=color]{padding:6px;border:1px solid #ccc;border-radius:6px;font-size:13px}
  .btn{padding:9px 14px;border-radius:8px;border:0;background:#0b7a44;color:#fff;font-weight:600;cursor:pointer}
  .btn.secondary{background:#2d6cdf}

  @page{size:A4;margin:0}
  @media print{.no-print{display:none}.sheet{page-break-after:always;border:0;box-shadow:none;margin:0;padding:0}}

  /* Portada a página completa */
 .cover-sheet{max-width:210mm;margin:0 auto 8mm;background:#fff;box-shadow:0 0 8px rgba(0,0,0,.08)}
  .cover-img{width:210mm;height:297mm;display:block;background:#fff;border:0}

  /* Hojas de menú */
  .sheet{max-width:210mm;margin:0 auto 8mm;background:var(--bg);padding:8mm 8mm 30mm 8mm;box-shadow:0 0 8px rgba(0,0,0,.08);position:relative}
  .header-img{width:100%;height:30mm;object-fit:contain;object-position:center;margin-bottom:4mm;border-radius:6px;background:#fff}
  .footer-abs{position:absolute;left:8mm;right:8mm;bottom:6mm;text-align:center}
  .footer-abs img{width:100%;height:22mm;object-fit:contain;filter:grayscale(.05) contrast(1.05)}

  h1{display:none}
  h2{font-size:18px;font-weight:700;margin:0;text-transform:uppercase;background:var(--theme);color:#fff;padding:6px 10px;border-radius:4px}
  .columns{columns:2 260px;column-gap:28px;margin-top:8px}
  .columns ol{margin:0 0 6px 1.2rem;padding:0}
  .columns li{margin:2px 0;break-inside:avoid}
  section{break-inside:avoid;page-break-inside:avoid}
  .price{font-weight:700;margin-top:6px}
  .includes{font-size:13px;color:#444;margin:0 0 10px;font-style:italic}
  .divider{height:2px;background:var(--theme);margin:20px 0;border-radius:2px}

  /* Alérgenos visibles con guiones */
  .allergen-sup{font-size:11px;line-height:1;vertical-align:super;color:#0b2f1b;font-weight:900;letter-spacing:.1px}
  .allergen-sep,.allergen-dash{font-size:11px;vertical-align:super;color:#0b2f1b}
  .allergen-sep{margin:0 2px}
  .allergen-dash{margin:0 1px}
</style>
</head>
<body>
  <div class="app">
    <div class="controls no-print">
      <!-- Cabecera SOLO: Guadina.png / cumbria.png / archivo -->
      <label>Cabecera:
        <select id="headerSelect">
          <option value="">Sin cabecera</option>
          <option value="Guadina.png" selected>Guadina.png</option>
          <option value="cumbria.png">cumbria.png</option>
          <option value="file">Elegir archivo…</option>
        </select>
        <input type="file" id="headerFile" accept="image/*" style="display:none">
      </label>

      <!-- Portada SOLO: Portada *.png / archivo -->
      <label>Portada:
        <select id="coverSelect">
          <option value="" selected>Sin portada</option>
          <option value="Portada Guadiana.png">Portada Guadiana.png</option>
          <option value="Portada Cumbria.png">Portada Cumbria.png</option>
          <option value="Portada Combinada.png">Portada Combinada.png</option>
          <option value="file">Elegir archivo…</option>
        </select>
        <input type="file" id="coverFile" accept="image/*" style="display:none">
      </label>

      <label>Ajuste portada:
        <select id="coverFit">
          <option value="cover">Cubrir (a sangre)</option>
          <option value="contain" selected>Contener (sin recortar)</option>
        </select>
      </label>

      <label>Color títulos: <input id="themeColor" type="color" value="#0b3d20"></label>
      <label>Fondo: <input id="bgColor" type="color" value="#ffffff"></label>

      <button id="pdfBtn" class="btn" type="button">Descargar PDF</button>
      <label>Imagen:
        <select id="imgFormat">
          <option value="png" selected>PNG (nítido)</option>
          <option value="jpeg">JPG (ligero)</option>
        </select>
      </label>
      <button id="imgBtn" class="btn secondary" type="button">Descargar imagen</button>
    </div>

    <div id="editor" class="no-print"></div>
    <div id="printHost"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    /* ===== Config ===== */
    const FOOTER_IMG = "Alergenos.jpg";
    let theme = '#0b3d20';
    let headerSrc = "Guadina.png"; // cabecera por defecto
    let coverSrc  = "";            // portada desactivada por defecto
    let coverFit  = 'contain';     // 'cover' | 'contain'

    const COCTELES_BASE=[
      {id:'c1',nombre:'CÓCTEL N.º 1',precio:20.00,incluye:'Vinos blanco y tinto de nuestra región · agua · refrescos · cervezas · zumos',items:[
        'Jamón ibérico con regañás (5)','Queso manchego D.O. (3)','Mini burger de buey (3,5,14)','Croquetas de jamón (2,3,5)',
        'Nido de patatas y langostinos (4,5,14)','Cucurucho de paté de mejillones en escabeche (3,4,5,7,14)',
        'Marinera de ensaladilla y anchoas (1,3,5,7,14)','Tiras de pollo Kentucky con chimichurri (3,5,7,14)',
        'Tortillitas de camarón con pimientos de padrón (7,14)','Pincho de salmón, gamba y piparra (1,5,6,14)',
        'Patatas chips (5)','Aceitunas sevillanas (14)','Pastelitos variados (3,5,7,14)']},
      {id:'c2',nombre:'CÓCTEL N.º 2',precio:24.00,incluye:'Vinos blanco y tinto de nuestra región · agua · refrescos · cervezas · zumos',items:[
        'Jamón ibérico con regañás (5)','Queso manchego D.O. (3)','Mini burger de buey (3,5,14)','Croquetas de jamón (2,3,5)','Nido de patatas y langostinos (4,5,14)',
        'Cucurucho de paté de mejillones en escabeche (3,4,5,7,14)','Marinera de ensaladilla y anchoas (1,3,5,7,14)','Tiras de pollo Kentucky con chimichurri (3,5,7,14)',
        'Tortillitas de camarón con pimientos de padrón (7,14)','Pincho de salmón, gamba y piparra (1,5.6,14)',
        'Mini pan bao con secreto y salsa hoisin (5,14)','Mediasnoches de ternera y setas (5,9,14)',
        'Patatas chips (5)','Aceitunas sevillanas (14)','Pastelitos variados (3,5,7,14)']},
      {id:'c3',nombre:'CÓCTEL N.º 3',precio:36.00,incluye:'Vinos blanco y tinto de nuestra región · agua · refrescos · cervezas · zumos',items:[
        'Jamón ibérico con regañás (5)','Queso manchego D.O. (3)','Mini burger de buey (3,5,14)','Croquetas de jamón (2,3,5)','Nido de patatas y langostinos (4,5,14)',
        'Cucurucho de paté de mejillones en escabeche (3,4,5,7,14)','Marinera de ensaladilla y anchoas (1,3,5,7,14)','Tiras de pollo Kentucky con chimichurri (3,5,7,14)',
        'Tortillitas de camarón con pimientos de padrón (7,14)','Pincho de salmón, gamba y piparra (1,5,6,14)',
        'Mini pan bao con secreto y salsa hoisin (5,14)','Medias noches de ternera y setas (5,9,14)','Brocheta de pollo teriyaki (9-14)',
        'Mini flamenquín casero con alioli (3,5,7,14)','Mini burritos con salsa ranchera (3,5,14)',
        'Empanadilla frita de atún (5,7,14)','Queso brie empanado con mahonesa de sriracha (3,5,14)',
        'Shawarma de pollo y alioli de cilantro (3,5,14)','Chips de verduras (5)','Aceitunas sevillanas (14)','Pastelitos variados (3,5,7,14)']}
    ];
    let state={cocteles:JSON.parse(JSON.stringify(COCTELES_BASE))};

    /* ===== Utils ===== */
    function fileToDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file);});}
    function sup(n){return `<span class="allergen-sup">${n}</span>`;}
    function sep(){return `<span class="allergen-sep">–</span>`;}
    function dash(){return `<span class="allergen-dash">–</span>`;}
    function parseAllergens(text){
      return text.replace(/\(([^)]*)\)/g,(m,p)=>{
        const groups=p.split(',').map(g=>g.trim()).filter(Boolean).map(g=>{
          if(g.includes('-')){const[a,b]=g.split('-').map(x=>x.trim());return sup(a)+dash()+sup(b);}
          return sup(g);
        });
        return groups.join(sep());
      });
    }
    function renderEditor(){
      const editor=document.getElementById('editor'); editor.innerHTML='';
      state.cocteles.forEach((c,idx)=>{
        const card=document.createElement('div');
        card.style.border='1px solid #ddd';card.style.borderRadius='8px';
        card.style.padding='10px';card.style.marginBottom='10px';
        card.innerHTML=`<div><strong>${c.nombre}</strong>
          <label><input type="checkbox" ${c.selected!==false?'checked':''}/> Incluir</label></div>
          <ul>${c.items.map(it=>`<li contenteditable="true">${it}</li>`).join('')}</ul>
          <div>Precio: <input type="number" step="0.10" value="${c.precio.toFixed(2)}"> €</div>
          <div>Incluye: <input type="text" value="${c.incluye}" style="width:80%"></div>`;
        card.querySelector('input[type="checkbox"]').addEventListener('change',e=>{state.cocteles[idx].selected=e.target.checked;});
        card.querySelectorAll('ul li').forEach((li,i)=>li.addEventListener('blur',()=>{state.cocteles[idx].items[i]=li.textContent;}));
        card.querySelector('input[type="number"]').addEventListener('input',e=>{state.cocteles[idx].precio=Number(e.target.value||0);});
        card.querySelector('input[type="text"]').addEventListener('input',e=>{state.cocteles[idx].incluye=e.target.value;});
        editor.appendChild(card);
      });
    }
    function waitImages(el){
      const imgs=[...el.querySelectorAll('img')];
      return Promise.all(imgs.map(img=>img.decode().catch(()=>{})));
    }

    /* ===== Render ===== */
    function renderPDFContent(){
      const host=document.getElementById('printHost'); host.innerHTML='';
      document.documentElement.style.setProperty('--theme', theme);

      /* Portada */
      if(coverSrc){
        const cs=document.createElement('div'); cs.className='cover-sheet';
        const img=new Image(); img.className='cover-img'; img.src=coverSrc; img.alt='Portada';
        img.style.objectFit = (coverFit==='cover'?'cover':'contain');
        img.style.objectPosition='center';
        cs.appendChild(img); host.appendChild(cs);
      }

      /* Menú: 2 cócteles por hoja, con cabecera y pie */
      const items=state.cocteles.filter(c=>c.selected!==false);
      for(let i=0;i<items.length;i+=2){
        const sh=document.createElement('div'); sh.className='sheet';
        if(headerSrc){ const h=new Image(); h.className='header-img'; h.src=headerSrc; h.alt='Cabecera'; sh.appendChild(h); }
        [items[i],items[i+1]].filter(Boolean).forEach(c=>{
          const sec=document.createElement('section');
          sec.innerHTML=`<h2>${c.nombre}</h2>
            <div class="columns"><ol>${c.items.map(it=>`<li>${parseAllergens(it)}</li>`).join('')}</ol></div>
            <div class="price">Precio unitario: ${c.precio.toFixed(2)} €</div>
            <p class="includes">Incluye: ${c.incluye}</p>
            <div class="divider"></div>`;
          sh.appendChild(sec);
        });
        const f=document.createElement('div'); f.className='footer-abs';
        f.innerHTML=`<img src="${"Alergenos.jpg"}" alt="Alérgenos">`;
        sh.appendChild(f); host.appendChild(sh);
      }
    }

    /* ===== Controles ===== */
    document.getElementById('themeColor').addEventListener('input',e=>{theme=e.target.value;renderPDFContent();});
    document.getElementById('bgColor').addEventListener('input',e=>{document.documentElement.style.setProperty('--bg',e.target.value);renderPDFContent();});

    // Cabecera (solo las válidas para cabecera)
    document.getElementById('headerSelect').addEventListener('change',e=>{
      const v=e.target.value, f=document.getElementById('headerFile');
      if(v==='file'){f.style.display='inline-block';f.click();return;}
      f.style.display='none'; headerSrc=v; renderPDFContent();
    });
    document.getElementById('headerFile').addEventListener('change',async e=>{
      const file=e.target.files[0]; if(!file) return;
      headerSrc=await fileToDataURL(file); renderPDFContent();
    });

    // Portada (solo las válidas para portada)
    document.getElementById('coverSelect').addEventListener('change',e=>{
      const v=e.target.value, f=document.getElementById('coverFile');
      if(v==='file'){f.style.display='inline-block';f.click();return;}
      f.style.display='none'; coverSrc=v; renderPDFContent();
    });
    document.getElementById('coverFile').addEventListener('change',async e=>{
      const file=e.target.files[0]; if(!file) return;
      coverSrc=await fileToDataURL(file); renderPDFContent();
    });
    document.getElementById('coverFit').addEventListener('change',e=>{coverFit=e.target.value; renderPDFContent();});

    /* ===== Exportación ===== */
    document.getElementById('pdfBtn').addEventListener('click', async()=>{
      try{
        renderPDFContent();
        const el=document.getElementById('printHost');
        await waitImages(el);
        const opt={margin:0,filename:'cocteles.pdf',
          image:{type:'jpeg',quality:0.98},
          html2canvas:{scale:2,useCORS:false,allowTaint:true,backgroundColor:null,logging:false},
          jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},
          pagebreak:{mode:['css','legacy']}
        };
        await html2pdf().set(opt).from(el).save();
      }catch(e){
        alert('Si la descarga directa falla, usa Imprimir → Guardar como PDF.');
        window.print();
      }
    });

    document.getElementById('imgBtn').addEventListener('click', async()=>{
      renderPDFContent();
      const el=document.getElementById('printHost');
      await waitImages(el);
      const fmt=document.getElementById('imgFormat').value; // png | jpeg
      const bg=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()||'#ffffff';
      const scale=Math.max(2,Math.min(3,window.devicePixelRatio||2));
      const canvas=await html2canvas(el,{scale,useCORS:false,allowTaint:true,backgroundColor:fmt==='png'?null:bg,logging:false});
      canvas.toBlob((blob)=>{
        if(!blob){alert('No se pudo crear la imagen.');return;}
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url; a.download=fmt==='png'?'cocteles.png':'cocteles.jpg';
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url),1000);
      }, fmt==='png'?'image/png':'image/jpeg', fmt==='png'?undefined:0.92);
    });

    /* ===== Inicio ===== */
    renderEditor();
    renderPDFContent();
  </script>
</body>
</html>
